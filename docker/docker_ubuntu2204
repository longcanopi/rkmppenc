FROM arm64v8/ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive \
    LOCAL_USER_ID=1000 \
    LOCAL_GROUP_ID=1000

RUN apt-get update \
    && apt install -y \
      sudo \
      wget \
      git \
      opencl-headers \
      libvdpau1 \
      libvulkan-dev \
      libva-x11-2 \
      libx11-dev \
      build-essential \
      cmake \
      libtool \
      pkg-config \
      libavcodec58 \
      libavcodec-dev \
      libavutil56 \
      libavutil-dev \
      libavformat58 \
      libavformat-dev \
      libswresample3 \
      libswresample-dev \
      libavfilter7 \
      libavfilter-dev \
      libass9 \
      libass-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/rockchip-linux/mpp && \
    cd mpp/build/linux/aarch64/ && \
    ./make-Makefiles.bash && make -j8 && sudo make install && \
    cd ../../../..

RUN git clone https://github.com/airockchip/librga && \
    cd librga && \
    sudo cp ./include/* /usr/local/include/rockchip/ && \
    sudo install -m 644 ./libs/Linux/gcc-aarch64/librga.a /usr/local/lib/ && \
    sudo install -m 755 ./libs/Linux/gcc-aarch64/librga.so /usr/local/lib/ && \
    sudo ln -s /usr/local/lib/librga.so /usr/local/lib/librga.so.2 && \
    cd ..

ENV LD_LIBRARY_PATH=/usr/local/lib

RUN useradd -u $LOCAL_USER_ID -m --user-group --shell /bin/bash rigaya
RUN groupmod -g $LOCAL_GROUP_ID rigaya
WORKDIR /home/rigaya
COPY . .
RUN chown -R rigaya:rigaya .
USER rigaya
